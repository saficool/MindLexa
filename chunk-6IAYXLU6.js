import{K as z,Q as U,R as B,S as g,T as j,U as S,V as d,W as w,X as c,Y as P,c as b,d as N,h as V,k as _,n as C,p as O,r as M}from"./chunk-GWYT2C5E.js";import{a as p,b as u,h as l}from"./chunk-TJICSKBO.js";var h=class o extends P{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),w([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}partial(e){return l(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=u(p({},this),{inputVariables:t,partialVariables:a});return new o(r)})}format(e){return l(this,null,function*(){let t={};for(let[i,n]of Object.entries(this.template))typeof n=="string"?t[i]=d(n,this.templateFormat,e):t[i]=n;let a=e.url||t.url,r=e.detail||t.detail;if(!a)throw new Error("Must provide either an image URL.");if(typeof a!="string")throw new Error("url must be a string.");let s={url:a};return r&&(s.detail=r),s})}formatPromptValue(e){return l(this,null,function*(){let t=yield this.format(e);return new B(t)})}};var y=class extends z{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}invoke(e,t){return l(this,null,function*(){return this._callWithConfig(a=>this.formatMessages(a),e,u(p({},t),{runType:"prompt"}))})}},F=class extends y{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}formatMessages(e){return l(this,null,function*(){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let r=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw r.name="InputFormatError",r}let a;try{Array.isArray(t)?a=t.map(M):a=[M(t)]}catch(r){let s=typeof t=="string"?t:JSON.stringify(t,null,2),i=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${s}`,`Additional message: ${r.message}`].join(`

`));throw i.name="InputFormatError",i}return a})}},E=class extends y{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}formatMessages(e){return l(this,null,function*(){return[yield this.format(e)]})}},x=class extends P{constructor(e){super(e)}format(e){return l(this,null,function*(){return(yield this.formatPromptValue(e)).toString()})}formatPromptValue(e){return l(this,null,function*(){let t=yield this.formatMessages(e);return new U(t)})}},k=class extends E{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}format(e){return l(this,null,function*(){return new _(yield this.prompt.format(e),this.role)})}static fromTemplate(e,t,a){return new this(c.fromTemplate(e,{templateFormat:a?.templateFormat}),t)}},v=class extends y{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let a=[];this.prompt.forEach(r=>{"inputVariables"in r&&(a=a.concat(r.inputVariables))}),this.inputVariables=a}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let a=t._messageClass();return new a({content:e})}else if(t.chatMessageClass){let a=t.chatMessageClass();return new a({content:e,role:this.getRoleFromMessageClass(a.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(c.fromTemplate(e,t));let a=[];for(let r of e)if(typeof r=="string"||typeof r=="object"&&"text"in r){let s="";typeof r=="string"?s=r:typeof r.text=="string"&&(s=r.text??"");let i=p(p({},t),typeof r!="string"?{additionalContentFields:r}:{});a.push(c.fromTemplate(s,i))}else if(typeof r=="object"&&"image_url"in r){let s=r.image_url??"",i,n=[];if(typeof s=="string"){let m;t?.templateFormat==="mustache"?m=S(s):m=j(s);let f=m.flatMap($=>$.type==="variable"?[$.name]:[]);if((f?.length??0)>0){if(f.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${f}
From: ${s}`);n=[f[0]]}else n=[];s={url:s},i=new h({template:s,inputVariables:n,templateFormat:t?.templateFormat,additionalContentFields:r})}else if(typeof s=="object"){if("url"in s){let m;t?.templateFormat==="mustache"?m=S(s.url):m=j(s.url),n=m.flatMap(f=>f.type==="variable"?[f.name]:[])}else n=[];i=new h({template:s,inputVariables:n,templateFormat:t?.templateFormat,additionalContentFields:r})}else throw new Error("Invalid image template");a.push(i)}return new this({prompt:a,additionalOptions:t})}format(e){return l(this,null,function*(){if(this.prompt instanceof g){let t=yield this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let a of this.prompt){let r={};if(!("inputVariables"in a))throw new Error(`Prompt ${a} does not have inputVariables defined.`);for(let s of a.inputVariables)r||(r={[s]:e[s]}),r=u(p({},r),{[s]:e[s]});if(a instanceof g){let s=yield a.format(r),i;"additionalContentFields"in a&&(i=a.additionalContentFields),t.push(u(p({},i),{type:"text",text:s}))}else if(a instanceof h){let s=yield a.format(r),i;"additionalContentFields"in a&&(i=a.additionalContentFields),t.push(u(p({},i),{type:"image_url",image_url:s}))}}return this.createMessage(t)}})}formatMessages(e){return l(this,null,function*(){return[yield this.format(e)]})}},T=class extends v{static _messageClass(){return C}static lc_name(){return"HumanMessagePromptTemplate"}},A=class extends v{static _messageClass(){return V}static lc_name(){return"AIMessagePromptTemplate"}},I=class extends v{static _messageClass(){return O}static lc_name(){return"SystemMessagePromptTemplate"}};function J(o){return typeof o.formatMessages=="function"}function q(o,e){if(J(o)||N(o))return o;if(Array.isArray(o)&&o[0]==="placeholder"){let r=o[1];if(typeof r!="string"||r[0]!=="{"||r[r.length-1]!=="}")throw new Error(`Invalid placeholder template: "${o[1]}". Expected a variable name surrounded by curly braces.`);let s=r.slice(1,-1);return new F({variableName:s,optional:!0})}let t=M(o),a;if(typeof t.content=="string"?a=t.content:a=t.content.map(r=>"text"in r?u(p({},r),{text:r.text}):"image_url"in r?u(p({},r),{image_url:r.image_url}):r),t._getType()==="human")return T.fromTemplate(a,e);if(t._getType()==="ai")return A.fromTemplate(a,e);if(t._getType()==="system")return I.fromTemplate(a,e);if(_.isInstance(t))return k.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function K(o){return o.constructor.lc_name()==="MessagesPlaceholder"}var R=class o extends x{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let n of this.promptMessages)if(!(n instanceof b))for(let m of n.inputVariables)t.add(m);let a=this.inputVariables,r=new Set(this.partialVariables?a.concat(Object.keys(this.partialVariables)):a),s=new Set([...r].filter(n=>!t.has(n)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);let i=new Set([...t].filter(n=>!r.has(n)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}_parseImagePrompts(e,t){return l(this,null,function*(){if(typeof e.content=="string")return e;let a=yield Promise.all(e.content.map(r=>l(this,null,function*(){if(r.type!=="image_url")return r;let s="";typeof r.image_url=="string"?s=r.image_url:s=r.image_url.url;let n=yield c.fromTemplate(s,{templateFormat:this.templateFormat}).format(t);return typeof r.image_url!="string"&&"url"in r.image_url?r.image_url.url=n:r.image_url=n,r})));return e.content=a,e})}formatMessages(e){return l(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=[];for(let r of this.promptMessages)if(r instanceof b)a.push(yield this._parseImagePrompts(r,t));else{let s=r.inputVariables.reduce((n,m)=>{if(!(m in t)&&!(K(r)&&r.optional))throw new Error(`Missing value for input variable \`${m.toString()}\``);return n[m]=t[m],n},{}),i=yield r.formatMessages(s);a=a.concat(i)}return a})}partial(e){return l(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=u(p({},this),{inputVariables:t,partialVariables:a});return new o(r)})}static fromTemplate(e,t){let a=c.fromTemplate(e,t),r=new T({prompt:a});return this.fromMessages([r])}static fromMessages(e,t){let a=e.reduce((i,n)=>i.concat(n instanceof o?n.promptMessages:[q(n,t)]),[]),r=e.reduce((i,n)=>n instanceof o?Object.assign(i,n.partialVariables):i,Object.create(null)),s=new Set;for(let i of a)if(!(i instanceof b))for(let n of i.inputVariables)n in r||s.add(n);return new this(u(p({},t),{inputVariables:[...s],promptMessages:a,partialVariables:r,templateFormat:t?.templateFormat}))}static fromPromptMessages(e){return this.fromMessages(e)}};var D=class o extends g{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),w(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}getExamples(e){return l(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")})}partial(e){return l(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=u(p({},this),{inputVariables:t,partialVariables:a});return new o(r)})}format(e){return l(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t),r=yield Promise.all(a.map(i=>this.examplePrompt.format(i))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return d(s,this.templateFormat,t)})}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static deserialize(e){return l(this,null,function*(){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let a=yield c.deserialize(t),r;if(Array.isArray(e.examples))r=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new o({inputVariables:e.input_variables,examplePrompt:a,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})})}},H=class o extends x{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),w(this.prefix+this.suffix,this.templateFormat,t)}}getExamples(e){return l(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")})}formatMessages(e){return l(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t);a=a.map(s=>{let i={};return this.examplePrompt.inputVariables.forEach(n=>{i[n]=s[n]}),i});let r=[];for(let s of a){let i=yield this.examplePrompt.formatMessages(s);r.push(...i)}return r})}format(e){return l(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t),s=(yield Promise.all(a.map(n=>this.examplePrompt.formatMessages(n)))).flat().map(n=>n.content),i=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return d(i,this.templateFormat,t)})}partial(e){return l(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=u(p({},this),{inputVariables:t,partialVariables:a});return new o(r)})}};export{R as a,D as b,H as c};
